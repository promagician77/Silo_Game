<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, shrink-to-fit=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="SILO DERPLES!" />
    <meta name="description" content="SILO DERPLES - An exciting game experience" />
    <meta name="theme-color" content="#111111" />
    <meta name="msapplication-TileColor" content="#111111" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.webmanifest" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="titlePageV2.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="titlePageV2.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="titlePageV2.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="titlePageV2.png" />
    
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="app-container" class="canvas-app-container">
      <div id="running-from-file-warning" style="display: none; margin: 3em">
        <h1>Running from local file ⚠️</h1>
        <p>
          It seems like you have opened this file by double-clicking on it. In
          order to test your build in a browser
          <b>you need to load this file from a web server</b>. You can either
          upload this file and the rest of the files from a Defold HTML5 bundle
          to a web hosting service OR host them using a local web server on your
          home network.
        </p>
        <p>
          <a
            href="https://defold.com/manuals/html5/#testing-html5-build"
            target="_blank"
            >Learn more about running a local web server in the Defold HTML5
            manual</a
          >.
        </p>
      </div>
      <div id="webgl-not-supported" style="display: none; margin: 3em">
        <h1>WebGL not supported ⚠️</h1>
        <p>
          WebGL is not supported by your browser - visit
          <a href="https://get.webgl.org/">https://get.webgl.org/</a> to learn
          more.
        </p>
      </div>
      <div id="canvas-container" class="canvas-app-canvas-container">
        <canvas
          id="canvas"
          class="canvas-app-canvas"
          tabindex="1"
          width="1280"
          height="720"
        ></canvas>
      </div>
      <div class="buttons-background"></div>
    </div>

    <div class="landing-background" id="landing-background"></div>

    <div class="overlay" id="auth-overlay">
      <div class="landing-content">
        <div id="signin-section">
          <div class="panel">
            <div class="row">
              <input id="email" type="email" placeholder="you@example.com" />
              <button id="send-link" class="primary">Send magic link</button>
            </div>

            <div class="row">
              <button id="guest">Guest quick play (30 turns)</button>
              <button id="signout" class="hide">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SCRIPTS ====== -->
    <script>
      // Fallback to make sure globalThis is available when running in an old browser
      if (typeof globalThis === "undefined") {
        window.globalThis = window;
      }
    </script>

    <script
      id="engine-loader"
      type="text/javascript"
      src="dmloader.js"
    ></script>

    <script id="engine-setup" type="text/javascript">
      // Game will be loaded when startNewGame() is called
      window.GAME_ENGINE_LOADED = false;
      window.GAME_ENGINE_LOADING = false;

      // Ensure GameAuth exists before engine loads (safety check)
      if (!window.GameAuth) {
        console.warn("[Engine] GameAuth not found, creating minimal stub...");
        window.GameAuth = {
          getMode: () => Promise.resolve(window.GAME_AUTH_MODE || 'guest'),
          getTokens: () => Promise.resolve(null),
          startSession: () => Promise.resolve(true),
          recordScore: () => Promise.resolve(false),
          getTopScores: (limit) => {
            console.log("[Engine] GameAuth.getTopScores called (stub)");
            return Promise.resolve([]);
          }
        };
      }

      // Override CUSTOM_PARAMETERS.start_success to mark engine as loaded
      if (typeof CUSTOM_PARAMETERS === 'undefined') {
        var CUSTOM_PARAMETERS = {};
      }
      CUSTOM_PARAMETERS.resize_window_callback = function() {
        var is_iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        var buttonHeight = 0;
        
        // Hack for iOS when exit from Fullscreen mode
        if (is_iOS) {
          window.scrollTo(0, 0);
        }
      
        var app_container = document.getElementById('app-container');
        var game_canvas = document.getElementById('canvas');
        
        // Lock canvas to 1280x720 - never change the size
        var width = 1280;
        var height = 720;
        var dpi = 1;
        
        // Keep container and canvas at fixed size
        app_container.style.width = width + "px";
        app_container.style.height = (height + buttonHeight) + "px";
        game_canvas.width = Math.floor(width * dpi);
        game_canvas.height = Math.floor(height * dpi);
        game_canvas.style.width = width + "px";
        game_canvas.style.height = height + "px";
      };
    </script>

    <script id="engine-start" type="text/javascript">
      var runningFromFileWarning = document.getElementById(
        "running-from-file-warning"
      );
      if (window.location.href.startsWith("file://")) {
        runningFromFileWarning.style.display = "block";
      } else {
        // Engine will be loaded when guest button is clicked or startNewGame() is called
        // Don't load immediately to save resources
        if (runningFromFileWarning && runningFromFileWarning.parentNode) {
          runningFromFileWarning.parentNode.removeChild(runningFromFileWarning);
        }
      }
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("sw.js").catch((err) => {
            console.warn("Service worker failed:", err);
          });
        });
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>